 "use strict"; 
function NSHierarchicalGrid(nsGrid,nsUtil) 
{
	this.__nsGrid = nsGrid;
	this.util = nsUtil;
	
	this.__ARROW_COLLAPSE_PATH = "M 0 0 L 0 10 L 10 5 Z";
	this.__ARROW_EXPANDED_PATH = "M 0 0 L 10 0 L 5 10 Z";
	this.__CLASS_ARROW = "nsGridArrowFill";
	
	this.__rowCounter = -1;
}
/********************************Common Functions for Grid ****************************************/
NSHierarchicalGrid.prototype.__initialize = function ()
{
};

NSHierarchicalGrid.prototype.propertyChange = function(attrName, oldVal, newVal, setProperty) 
{
	var attributeName = attrName.toLowerCase();
};

NSHierarchicalGrid.prototype.dataSource = function(source)
{
	this.__nsGrid.__arrWrapper = this.__nsGrid.__dataSource.slice(0);
	this.__setWrapperSource(this.__nsGrid.__arrWrapper,0,-1,0);
	this.__nsGrid.__updateTotalRecords(this.__rowCounter);
	if(this.__nsGrid.__enablePagination && this.__nsGrid.__isPaginationModeAuto)
	{
		if(this.__nsGrid.__isPaginationTypeScroll)
		{
			this.__nsGrid.__arrInternalSource = this.__nsGrid.__arrFlatHierarchicalSource.slice(0,this.__nsGrid.__INFINITE_SCROLL_INITIAL_LOAD);
			this.__nsGrid.__fetchRecordCallBack = this.__addRowsforScrollPagination.bind(this);
		}
		else 
		{
			this.__nsGrid.__arrInternalSource = this.__nsGrid.__arrFlatHierarchicalSource.slice(0,this.__nsGrid.__pageSize);
			this.__nsGrid.__createPaginationControl(this.__nsGrid.__divOuterContainer);
			this.__nsGrid.__fetchRecordCallBack = this.__addRowsforPagePagination.bind(this);
		}
	}
	else
	{
		this.__nsGrid.__arrInternalSource = this.__nsGrid.__arrWrapper.slice(0);
	}
};

NSHierarchicalGrid.prototype.__createBodyBody= function(dataSet,startIndex,endIndex)
{
    if(dataSet && dataSet.length > 0)
    {
    	for (var rowIndex = startIndex; rowIndex < endIndex; rowIndex++)
	    {
    		var item = dataSet[rowIndex];
    		var row = item[this.__nsGrid.__fieldRowHtml];
    		this.__nsGrid.__tblBodyBody.appendChild(row);
    		if(item[this.__nsGrid.__fieldHasChild] && !this.__nsGrid.__addRemoveRowCallInternal)
    		{
    			this.__createBodyBody(item[this.__nsGrid.__childField], 0, item[this.__nsGrid.__childField].length);
    		}
	    }
    }
};

NSHierarchicalGrid.prototype.__createBodyBodyVirtual= function(dataSet,totalRows,level)
{
	if(dataSet && dataSet.length > 0)
    {
    	if(!level)
    	{
    		level = 0;
    		this.__rowCounter = 0;
    		dataSet = this.__nsGrid.__arrFlatHierarchicalSource;
    	}
    	if(dataSet && totalRows > dataSet.length)
    	{
    		totalRows = dataSet.length;
    	}
    	/*for (var rowIndex = 0; rowIndex < length; rowIndex++,this.__rowCounter++)
	    {
    		if(this.__rowCounter >= totalRows)
    		{
    			break;
    		}
    		var item = dataSet[rowIndex];
    		var row = item[this.__nsGrid.__fieldRowHtml];
    		this.__nsGrid.__tblBodyBody.appendChild(row);
    		if(item[this.__nsGrid.__fieldHasChild])
    		{
    			this.__createBodyBodyVirtual(item[this.__nsGrid.__childField],totalRows,level + 1);
    		}
	    }*/
    	for (var rowIndex = 0; rowIndex < totalRows; rowIndex++)
	    {
    		var item = dataSet[rowIndex];
    		var row = item[this.__nsGrid.__fieldRowHtml];
    		this.__nsGrid.__tblBodyBody.appendChild(row);
	    }
    }
};

NSHierarchicalGrid.prototype.__createBody = function()
{
};

NSHierarchicalGrid.prototype.__checkForAdditionalColumns = function()
{
};

NSHierarchicalGrid.prototype.__setMeasurement = function()
{
};

NSHierarchicalGrid.prototype.__addSVGInPage = function(objSVG)
{
	objSVG.addPath("svgArrowDown",this.__ARROW_EXPANDED_PATH,"0 0 16 16");
	objSVG.addPath("svgArrowRight",this.__ARROW_COLLAPSE_PATH,"0 0 16 16");
};

NSHierarchicalGrid.prototype.__setWrapperSource = function(source,offset,parentIndex,level)
{
	if(source)
	{
		if(!offset)
		{
			offset = 0;
		}
		var length = source.length;
		for (var count = 0; count < length; count++) 
		{
			var item = source[count];
			var row = document.createElement("TR");
			item[this.__nsGrid.__fieldRowHtml] = row;
			var index = ++this.__rowCounter + offset;
			row.setAttribute("index",index);
			row.setAttribute("level",level);
			this.__nsGrid.__arrFlatHierarchicalSource.push(item);
			this.__setBodyRowProperty(row,item,parentIndex,level);
			var colLength = this.__nsGrid.__columns.length;
			for (var colIndex = 0; colIndex < colLength; colIndex++)
	        {
	        	var colItem = this.__nsGrid.__columns[colIndex];
	        	var cell =  row.insertCell(-1);
	        	this.util.addStyleClass(cell , "nsDataGridCell");
	            var cellDiv = this.util.createDiv(null);
	            cell.appendChild(cellDiv);
	            this.__setBodyCellProperty(row,cell,item,index,colItem,colIndex,parentIndex,level);
	        }
		}
	}
};

NSHierarchicalGrid.prototype.__resetDataInBody= function(fromIndex,toIndex)
{
	var arrSource = this.__nsGrid.__arrFlatHierarchicalSource.slice(fromIndex,toIndex + 1);
	var indexCount = fromIndex;
	var totalRecords = this.__nsGrid.__totalRecords;
	var arrRows = this.__nsGrid.__tblBodyBody.rows;
	for(var rowIndex = 0; rowIndex < arrRows.length; rowIndex++,indexCount++)
    {
		var row = arrRows[rowIndex];
		if(indexCount < totalRecords)
		{
			row.style.display = "";
			var item = arrSource[rowIndex];
			if(item && item[this.__nsGrid.__fieldRowVisible])
			{
				row.outerHTML = item[this.__nsGrid.__fieldRowHtml].outerHTML;
				/*var compArrow = row.querySelector(".nsArrow");
				if(compArrow)
				{
					this.util.addEvent(compArrow,"click",this.__nsGrid.__arrowClickHandler.bind(this.__nsGrid));
				}*/
			}
			else
			{
				row.style.display = "none";
			}
		}
		else
		{
			row.style.display = "none";
		}
    }
};
/********************************End of Common Functions for Grid ****************************************/
NSHierarchicalGrid.prototype.__setBodyRowProperty = function(row,item,parentIndex,level)
{
	if(row && item)
	{
		var totalRowCount = this.__rowCounter;
		this.__nsGrid.__setBodyRowProperty(row,item,totalRowCount);
		item[this.__nsGrid.__fieldIndex] = totalRowCount;
		item[this.__nsGrid.__fieldRowLevel] = level;
		var hasChild = false;
		if(item.hasOwnProperty(this.__nsGrid.__childField) && item[this.__nsGrid.__childField] && item[this.__nsGrid.__childField].length > 0)
	    {
	    	hasChild = true;
	    	this.__setWrapperSource(item[this.__nsGrid.__childField],0,totalRowCount,level + 1);
	    }
		item[this.__nsGrid.__fieldParentIndex] = parentIndex;
		if(parentIndex > -1)
	    {
			item[this.__nsGrid.__fieldHasParent] = true;
			row.setAttribute("parent-index",parentIndex);
	    }
		else
		{
			item[this.__nsGrid.__fieldHasParent] = false;
		}
		item[this.__nsGrid.__fieldHasChild] = hasChild;
		item[this.__nsGrid.__fieldRowVisible] = true;
		item[this.__nsGrid.__fieldIsCollapsed] = false;
	}
};

NSHierarchicalGrid.prototype.__setBodyCellProperty = function(row,cell,item,currentIndex,colItem,colIndex,parentIndex,level)
{
	var hierarchicalPadding = 0;
	if(colItem && colItem.hasOwnProperty("dataField") && colItem["dataField"])
	{
		var cellDiv = cell.firstChild;
        if(colIndex == 0 && item[this.__nsGrid.__childField]  && item[this.__nsGrid.__childField].length > 0)
        {
        	this.util.addStyleClass(cellDiv,this.__nsGrid.__CLASS_GROUP_CELL);
        	this.__nsGrid.__createArrow(item,currentIndex,cellDiv,false);
        	var cellText = this.util.createDiv(null,this.__nsGrid.__CLASS_CELL_CHILD);
        	cellText.style.verticalAlign = "top";
        	this.__nsGrid.__addCellText(row,item,cellText,colItem,colIndex);
        	cellDiv.appendChild(cellText);
        }
        else
        {
        	this.util.addStyleClass(cellDiv,this.__nsGrid.__CLASS_CELL_CHILD);
        	this.__nsGrid.__addCellText(row,item,cellDiv,colItem,colIndex);
        	//24 = 16(Arrow Width) + 6(Arrow Parent Padding) + 2(cellDiv horizontalGap between elements shown in debugger)
        	hierarchicalPadding = 24;
        }
        if(colIndex == 0)
        {
        	if(level === 0)
        	{
        		cell.style.paddingLeft = "1px";
        	}
        	else
        	{
        		var paddingLeft = (10 * level) + hierarchicalPadding;
        		cell.style.paddingLeft = paddingLeft + "px";
        	}
        }
	}
	this.__nsGrid.__addPriorityClassInCell(cell,colItem);
};

NSHierarchicalGrid.prototype.__createArrow = function(compArrow,objSVG,arrowID)
{
	 var svg = objSVG.addSVG(compArrow,arrowID + "svg",this.__CLASS_ARROW,null,null,null,null,null,null,true);
	 objSVG.addUse(svg,arrowID + "use",null,"#svgArrowDown");
};

NSHierarchicalGrid.prototype.__setArrowDirection = function(objSVG,useID,isCollapsed)
{
	if(isCollapsed)
	{
		objSVG.changeUseHref(useID,"#svgArrowRight");
	}
	else
	{
		objSVG.changeUseHref(useID,"#svgArrowDown");
	}
};

NSHierarchicalGrid.prototype.__addRowsforScrollPagination = function(fromRecord,toRecord,pageSize)
{
	console.log("In __addRowsforScrollPagination " + fromRecord + "," + toRecord + "," + pageSize);
	var arrArray = this.__nsGrid.__arrFlatHierarchicalSource.slice(fromRecord,toRecord + 1); 
	this.__nsGrid.__addRemoveRowCallInternal = true;
	this.__nsGrid.addRows(arrArray);
};

NSHierarchicalGrid.prototype.__addRowsforPagePagination = function(fromRecord,toRecord,pageSize)
{
	//slice returns index range from fromRecord to toRecord - 1 hence adding 1 
	this.__nsGrid.__arrInternalSource = this.__nsGrid.__arrWrapper.slice(fromRecord,toRecord + 1);
	this.__nsGrid.__resetDataInBody(fromRecord,toRecord,true);
};
