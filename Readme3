"use strict"; 
function NMPanel(setting) 
{
	this.__DEFAULT_ANIMATION_STEPS = 10;
	this.__DEFAULT_ANIMATION_DELAY = 20; /*ms*/
	
	this.__OUTER_CONTAINER_ID = "panelContainer";
	this.__TITLE_CONTAINER_ID = "divTitleBar";
	this.__BODY_CONTAINER_ID = "divBody";
	
	this.__CLASS_OUTER_CONTAINER = "nmPanel";
	this.__CLASS_TITLEBAR = "nmPanelTitleBar";
	this.__CLASS_BODY_CONTAINER = "nmPanelBody";
	this.__CLASS_BODY_CONTAINER_TOGGLED = "nmPanelBodyToggled";
	
	this.util = new NMUtil();
	
	this.__setting = setting;
	this.__config = null;
	this.__header = null;
	this.__body = null;
	
	this.__id = null;
	this.__orignalBodyHeight = -1;

	this.__initialize();
}

NMPanel.prototype.__initialize = function() 
{
	if(this.__setting)
	{
		//eventHandler:extra eventHandler which developer wants to execute on the event i.e. click,customEvent etc
		this.__config = {
				parent: this.__setting["parent"] || null,
				title: this.__setting["title"] || null,
				template: this.__setting["template"] || null,
				maxWidth: this.__setting["maxWidth"] || -1,
				maxHeight: this.__setting["maxHeight"] || -1
		};
		if(this.__config.parent)
		{
			this.__createStructure();
		}
	}
};

NMPanel.prototype.__createStructure = function()
{
	var divOuterContainer = this.__createOuterContainer();
	this.__header = this.__createTitleBar(divOuterContainer);
	this.__body = this.__createBody(divOuterContainer);
};

NMPanel.prototype.__createOuterContainer = function()
{
	var divOuterContainer = this.util.getElement(this.getID() + this.__OUTER_CONTAINER_ID,this.__CLASS_OUTER_CONTAINER);
	if(divOuterContainer)
	{
		divOuterContainer.parentNode.removeChild(divOuterContainer);
		divOuterContainer = null;
	}
	divOuterContainer = this.util.createDiv(this.getID() + this.__OUTER_CONTAINER_ID);
	if(this.__config.parent.style.width != "")
	{
		divOuterContainer.style.width = this.__config.parent.style.width;
	}
	else if(this.offsetWidth > 0)
	{
		divOuterContainer.style.width = this.__config.parent.offsetWidth + "px";
	}
	else
	{
		divOuterContainer.style.width = "100%";
	}
	if(this.__config.parent.style.height != "")
	{
		divOuterContainer.style.height = this.__config.parent.style.height;
	}
	else if(this.__config.parent.offsetHeight > 0)
	{
		divOuterContainer.style.height = this.__config.parent.offsetHeight + "px";
	}
	else
	{
		divOuterContainer.style.height = "100%";
	}
	this.__config.parent.appendChild(divOuterContainer);
	return divOuterContainer;
};

NMPanel.prototype.__createTitleBar = function(parentElement)
{
	if(parentElement)
	{
		var divTitleBar = this.util.createDiv(this.getID() + this.__TITLE_CONTAINER_ID,this.__CLASS_TITLEBAR);
		if(this.__config.title && this.__config.title.length > 0)
		{
			var titleText = document.createTextNode(this.__config.title);
			divTitleBar.appendChild(titleText);
		}
		this.util.addEvent(divTitleBar,"dblclick",this.__headerDoubleClickHandler.bind(this));
		parentElement.appendChild(divTitleBar);
		
		return divTitleBar;
	}
	return null;
};

NMPanel.prototype.__createBody = function(parentElement)
{	
	if(parentElement)
	{
		var divBody = this.util.createDiv(this.getID() + this.__BODY_CONTAINER_ID,this.__CLASS_BODY_CONTAINER);
		if(this.__config.template)
		{
			divBody.appendChild(this.util.getTemplate(this.__config.template));
		}
		parentElement.appendChild(divBody);
		if(this.__config.maxWidth > -1 && this.__config.maxWidth < divBody.offsetWidth)
		{
			divBody.style.maxWidth = this.__config.maxWidth + "px";
		}
		if(this.__config.maxHeight > -1 && this.__config.maxHeight < divBody.offsetHeight)
		{
			divBody.style.maxHeight = this.__config.maxHeight + "px";
		}
		this.__orignalBodyHeight = divBody.offsetHeight;
		/*var transitionStyle = "height .3s linear, padding-top .3s linear,padding-bottom .3s linear, border-width .3s linear";
		var transitionProperty = this.util.getSupportedCSSPropertyName(["transition","OTransition","msTransition","MozTransition","WebkitTransition"]);
		if(transitionProperty)
		{
			divBody.style[transitionProperty] = transitionStyle;
		}*/
		return divBody;
	}
	return null;
};

NMPanel.prototype.__headerDoubleClickHandler = function(event)
{
	if(this.__body)
	{
		//this.util.toggleStyleClass(this.__body,this.__CLASS_BODY_CONTAINER_TOGGLED);
		var height = this.__body.offsetHeight;
		if(this.__body.style.height != "")
		{
			height = this.util.getDimensionAsNumber(this.__body,this.__body.style.height);
		}
		var isExpand = (height === 0);
		this.__animateToggle(isExpand);
	}
};

NMPanel.prototype.__animateToggle = function(isExpand)
{
	var contentHeight = this.__body.offsetHeight;
	if (isExpand)
	{
		this.__body.style.height = "0px";
	}
	var stepHeight = this.__orignalBodyHeight / this.__DEFAULT_ANIMATION_STEPS;
	var direction = (isExpand ? 1 : -1);
	var self = this;
	setTimeout(function(){self.__animateStep.bind(self)(1,stepHeight,direction)}, this.__DEFAULT_ANIMATION_DELAY);
};

NMPanel.prototype.__animateStep = function(iteration, stepHeight, direction)
{
	if (iteration < this.__DEFAULT_ANIMATION_STEPS)
	{
		this.__body.style.height = Math.round(((direction > 0) ? iteration : 10 - iteration) * stepHeight) +"px";
		iteration++;
		var self = this;
		setTimeout(function(){self.__animateStep.bind(self)(iteration,stepHeight,direction)}, this.__DEFAULT_ANIMATION_DELAY);
	}
	else
	{
		this.__body.style.height = ((direction < 0) ? 0 : this.__orignalBodyHeight) + "px";
	}
};

NMPanel.prototype.getID = function()
{
	if(!this.__id)
	{
		if(this.__config.parent.hasAttribute("id"))
		{
			this.__id = this.__config.parent.getAttribute("id");
		}
		else if(this.__config.parent.hasAttribute("name"))
		{
			this.__id = this.__config.parent.getAttribute("name");
		}
	}
	return this.__id;
};
